@page "/stats"
@using tinyutils.Data
@using tinyutils.Services
@inject AuditService AuditService

<PageTitle>Statistics - tinyutils</PageTitle>

<div class="min-h-screen py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header Section -->
        <div class="text-center mb-12">
            <div
                class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-2xl mb-4 transform hover:rotate-3 transition-transform">
                <!-- Placeholder SVG Icon - Chart -->
                <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
            </div>
            <h1
                class="text-4xl sm:text-5xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-3">
                Usage Statistics
            </h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                A peek at what you've been up to.
            </p>
        </div>

        @if (logs == null)
        {
            <!-- Loading State -->
            <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-12">
                <div class="flex flex-col items-center justify-center">
                    <svg class="animate-spin h-12 w-12 text-indigo-600 mb-4" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    <p class="text-gray-600 font-medium">Loading your stats...</p>
                </div>
            </div>
        }
        else if (!logs.Any())
        {
            <!-- Empty State -->
            <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-12">
                <div class="flex flex-col items-center justify-center text-center max-w-md mx-auto">
                    <div
                        class="w-20 h-20 bg-gradient-to-br from-gray-100 to-gray-200 rounded-3xl flex items-center justify-center mb-6">
                        <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">Nothing here yet</h3>
                    <p class="text-gray-600 mb-6 leading-relaxed">
                        No usage data yet. Go try out some tools and come back to see your stats!
                    </p>
                    <div class="flex flex-wrap gap-3 justify-center">
                        <a href="/json-formatter"
                            class="inline-flex items-center gap-2 px-5 py-2 bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-full font-semibold text-sm hover:shadow-lg transition-all">
                            <span>JSON Formatter</span>
                        </a>
                        <a href="/image-converter"
                            class="inline-flex items-center gap-2 px-5 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-full font-semibold text-sm hover:shadow-lg transition-all">
                            <span>Image Converter</span>
                        </a>
                        <a href="/image-compressor"
                            class="inline-flex items-center gap-2 px-5 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full font-semibold text-sm hover:shadow-lg transition-all">
                            <span>Image Compressor</span>
                        </a>
                    </div>
                </div>
            </div>
        }
        else
        {
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl border border-blue-200 p-6">
                    <div class="flex items-center gap-3 mb-2">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                            </svg>
                        </div>
                        <p class="text-sm font-semibold text-blue-900 uppercase tracking-wide">Total Uses</p>
                    </div>
                    <p class="text-3xl font-bold text-gray-900">@logs.Count</p>
                </div>

                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl border border-green-200 p-6">
                    <div class="flex items-center gap-3 mb-2">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                            </svg>
                        </div>
                        <p class="text-sm font-semibold text-green-900 uppercase tracking-wide">Data Processed</p>
                    </div>
                    <p class="text-3xl font-bold text-gray-900">@FormatBytes(logs.Sum(l => l.InputSizeBytes))</p>
                </div>

                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl border border-purple-200 p-6">
                    <div class="flex items-center gap-3 mb-2">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <p class="text-sm font-semibold text-purple-900 uppercase tracking-wide">Avg Speed</p>
                    </div>
                    <p class="text-3xl font-bold text-gray-900">@(logs.Average(l => l.ProcessingTimeMs).ToString("F0"))ms
                    </p>
                </div>

                <div class="bg-gradient-to-br from-orange-50 to-amber-50 rounded-2xl border border-orange-200 p-6">
                    <div class="flex items-center gap-3 mb-2">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-orange-500 to-amber-500 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                            </svg>
                        </div>
                        <p class="text-sm font-semibold text-orange-900 uppercase tracking-wide">Favorite Tool</p>
                    </div>
                    <p class="text-lg font-bold text-gray-900">@logs.GroupBy(l => l.ToolName).OrderByDescending(g =>
                                            g.Count()).First().Key</p>
            </div>
        </div>

            <!-- Recent Activity Table -->
            <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden">
                <div class="p-6 sm:p-8 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                        <span class="inline-block w-2 h-2 bg-indigo-500 rounded-full"></span>
                        Recent Activity
                    </h2>
                    <p class="text-sm text-gray-600 mt-1">Your last 50 tool uses</p>
                </div>

                <!-- Desktop Table -->
                <div class="hidden lg:block overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    Time
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    Tool
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    Input Size
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    Output Size
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    Speed
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-50">
                        @foreach (var log in logs)
                            {
                                <tr class="hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">
                                        @log.Timestamp.ToLocalTime().ToString("g")
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span
                                            class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold
                                                                            @(log.ToolName == "JSON Formatter" ? "bg-orange-100 text-orange-800" :
                                                                                                                                                                                                                                log.ToolName == "Image Converter" ? "bg-blue-100 text-blue-800" : 
                                                                                                                                                                                                                                "bg-purple-100 text-purple-800")">
                                            <span
                                                class="inline-block w-1.5 h-1.5 rounded-full
                                                                                @(log.ToolName == "JSON Formatter" ? "bg-orange-500" :
                                                                                                                                                                                                                                                      log.ToolName == "Image Converter" ? "bg-blue-500" : 
                                                                                                                                                                                                                                                      "bg-purple-500")">
                                            </span>
                                            @log.ToolName
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-mono">
                                        @FormatBytes(log.InputSizeBytes)
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-mono">
                                        @FormatBytes(log.OutputSizeBytes)
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <span class="inline-flex items-center gap-1 text-gray-700 font-mono">
                                            <svg class="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                            @log.ProcessingTimeMs.ToString("F2")ms
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Cards -->
                <div class="lg:hidden p-4 space-y-4">
                    @foreach (var log in logs)
                    {
                        <div class="bg-gradient-to-br from-gray-50 to-white rounded-2xl border border-gray-200 p-5">
                            <div class="flex items-start justify-between mb-3">
                                <span
                                    class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold
                                                                    @(log.ToolName == "JSON Formatter" ? "bg-orange-100 text-orange-800" :
                                                                                                                                                                                          log.ToolName == "Image Converter" ? "bg-blue-100 text-blue-800" : 
                                                                                                                                                                                          "bg-purple-100 text-purple-800")">
                                    <span
                                        class="inline-block w-1.5 h-1.5 rounded-full
                                                                        @(log.ToolName == "JSON Formatter" ? "bg-orange-500" :
                                                                                                                                                                                                              log.ToolName == "Image Converter" ? "bg-blue-500" : 
                                                                                                                                                                                                              "bg-purple-500")">
                                    </span>
                                    @log.ToolName
                                </span>
                                <span class="text-xs text-gray-500">
                                    @log.Timestamp.ToLocalTime().ToString("g")
                                </span>
                            </div>
                            <div class="grid grid-cols-3 gap-3 text-xs">
                                <div>
                                    <p class="text-gray-500 mb-1 font-semibold">Input</p>
                                    <p class="text-gray-900 font-mono">@FormatBytes(log.InputSizeBytes)</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 mb-1 font-semibold">Output</p>
                                    <p class="text-gray-900 font-mono">@FormatBytes(log.OutputSizeBytes)</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 mb-1 font-semibold">Speed</p>
                                    <p class="text-gray-900 font-mono">@log.ProcessingTimeMs.ToString("F2")ms</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Info Footer -->
        <div class="text-center mt-8 text-sm text-gray-500">
            <p>Stats are stored locally. ðŸ“Š</p>
        </div>
    </div>
</div>

@code {
    private List<AuditLog>? logs;

    protected override async Task OnInitializedAsync()
    {
        logs = await AuditService.GetRecentLogsAsync(50);
    }

    private string FormatBytes(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024):F1} MB";
    }
}