@page "/image-compressor"
@using tinyutils.Services
@inject ImageConverterService ImageService
@inject AuditService AuditService
@inject IJSRuntime JS

@rendermode InteractiveServer

<PageTitle>Image Compressor - tinyutils</PageTitle>

<div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl mx-auto my-10">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Image Compressor</h1>
    <p class="text-gray-600 mb-8">Reduce image file size while maintaining quality</p>

    <div class="mb-6 border-b pb-6 border-gray-100">
        <label class="block text-lg font-semibold text-gray-700 mb-2">
            Upload Image
        </label>
        <InputFile OnChange="HandleFileSelected" accept="image/*"
            class="block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-full file:border-0 file:text-base file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition duration-150 ease-in-out cursor-pointer" />
    </div>

    @if (uploadedFile != null)
    {
        <div class="mb-6 p-4 bg-gray-50 rounded-lg shadow-inner">
            <p class="text-base font-medium text-gray-800">
                <span class="font-bold">Original:</span> @uploadedFile.Name
                (@FormatBytes(uploadedFile.Size))
            </p>
        </div>

        <div class="mb-8">
            <label class="block text-lg font-semibold text-gray-700 mb-3">
                Quality: <span class="text-blue-600 font-extrabold">@quality %</span>
            </label>
            <input type="range" min="10" max="100" @bind="quality" @bind:event="oninput"
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg" />
            <div class="flex justify-between text-xs text-gray-500 mt-2">
                <span>Smaller file (lower quality)</span>
                <span>Better quality (larger file)</span>
            </div>
        </div>

        <button @onclick="CompressImage" disabled="@isProcessing"
            class="w-full px-6 py-3 text-lg font-semibold text-white rounded-lg shadow-md transition duration-150 ease-in-out
                                       @(isProcessing ? "bg-gray-400 cursor-not-allowed" : "bg-blue-600 hover:bg-blue-700 active:bg-blue-800")">
            @(isProcessing ? "Compressing..." : "Compress Image")
        </button>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="mt-6 p-4 bg-red-50 border border-red-300 rounded-lg">
            <p class="text-red-700 font-medium">@errorMessage</p>
        </div>
    }

    @if (compressedImageData != null)
    {
        <div class="mt-8 pt-8 border-t border-gray-200">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">Compression Result</h3>

            <div class="mb-6 p-4 bg-green-50 border border-green-300 rounded-lg">
                <p class="text-green-800 font-medium mb-2">
                    âœ“ Compressed successfully!
                </p>
                <div class="text-sm text-gray-700 space-y-1">
                    <p>
                        <span class="font-bold">Original size:</span>
                        @FormatBytes(originalSize)
                    </p>
                    <p>
                        <span class="font-bold">Compressed size:</span>
                        @FormatBytes(compressedImageData.Length)
                    </p>
                    <p class="text-lg text-green-700 font-extrabold">
                        <span class="font-bold">Savings:</span> @savingsPercentage %
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">Original</h4>
                    <img src="@originalImageUrl" alt="Original"
                        class="w-full h-auto rounded-lg shadow-xl border border-gray-200" />
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">Compressed (Q: @quality%)</h4>
                    <img src="@compressedImageDataUrl" alt="Compressed"
                        class="w-full h-auto rounded-lg shadow-xl border border-gray-200" />
                </div>
            </div>

            <button @onclick="DownloadImage"
                class="w-full px-6 py-3 text-lg font-semibold text-white rounded-lg shadow-md transition duration-150 ease-in-out bg-green-600 hover:bg-green-700 active:bg-green-800">
                Download Compressed Image
            </button>
        </div>
    }
</div>

@code {
    private IBrowserFile? uploadedFile;
    private int quality = 75;
    private bool isProcessing = false;
    private string? errorMessage;
    private byte[]? compressedImageData;
    private string? compressedImageDataUrl;
    private string? originalImageUrl;
    private string? downloadFileName;
    private long originalSize;
    private int savingsPercentage;

    // Standard JS interop for file downloading
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("eval", @"
window.downloadFile = function (fileName, base64Data) {
const link = document.createElement('a');
link.href = 'data:application/octet-stream;base64,' + base64Data;
link.download = fileName;
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
};
");
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        compressedImageData = null;
        errorMessage = null;

        using var stream = uploadedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
        using var ms = new MemoryStream();

        await stream.CopyToAsync(ms);

        var originalBytes = ms.ToArray();
        originalSize = originalBytes.Length;

        originalImageUrl = $"data:{uploadedFile.ContentType};base64,{Convert.ToBase64String(originalBytes)}";
    }

    private async Task CompressImage()
    {
        if (uploadedFile == null) return;

        isProcessing = true;
        errorMessage = null;
        compressedImageData = null;

        try
        {
            var startTime = DateTime.UtcNow;
            using var stream = uploadedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);

            var result = await ImageService.CompressImageAsync(stream, quality);

            if (result.Success && result.ImageData != null)
            {
                compressedImageData = result.ImageData;
                compressedImageDataUrl = $"data:{result.ContentType};base64,{Convert.ToBase64String(result.ImageData)}";
                downloadFileName = $"compressed.{result.FileExtension}";

                savingsPercentage = (int)((1 -
                (double)result.ImageData.Length / originalSize) * 100);

                var processingTime = (DateTime.UtcNow - startTime).TotalMilliseconds;

                await AuditService.LogUsageAsync(
                toolName: "Image Compressor",
                inputSize: originalSize,
                outputSize: result.ImageData.Length,
                processingTimeMs: processingTime
                );
            }
            else
            {
                errorMessage = result.ErrorMessage ?? "Compression failed";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task DownloadImage()
    {
        if (compressedImageData == null || string.IsNullOrEmpty(downloadFileName)) return;

        var base64 = Convert.ToBase64String(compressedImageData);
        await JS.InvokeVoidAsync("downloadFile", downloadFileName, base64);
    }

    private string FormatBytes(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";

        return $"{bytes / (1024.0 * 1024):F1} MB";
    }
}